<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>CRM Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --bg: #f3f4f6;
        --panel: #ffffff;
        --panel-2: #f8fafc;
        --primary: #a855f7;
        --primary-2: #8b5cf6;
        --accent: #f97316;
        --text: #111827;
        --muted: #4b5563;
        --border: #e5e7eb;
        --danger: #ef4444;
        --success: #16a34a;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        background: radial-gradient(circle at 12% 18%, rgba(168, 85, 247, 0.08), transparent 28%),
          radial-gradient(circle at 86% 8%, rgba(249, 115, 22, 0.07), transparent 24%),
          var(--bg);
        color: var(--text);
      }

      header {
        padding: 14px 18px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(135deg, var(--primary), var(--primary-2));
        color: #fff;
        box-shadow: 0 8px 24px rgba(168, 85, 247, 0.18);
      }

      header h1 {
        margin: 0;
        font-size: 18px;
        font-weight: 800;
        letter-spacing: 0.4px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      main {
        padding: clamp(16px, 4vw, 32px);
        max-width: 1200px;
        margin: 0 auto;
      }

      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 20px;
      }

      .tab-btn {
        padding: 10px 16px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: var(--muted);
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
      }

      .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      .tab-content { display: none; }
      .tab-content.active { display: block; }

      .card {
        background: var(--panel);
        border-radius: 14px;
        border: 1px solid var(--border);
        padding: 24px;
        box-shadow: 0 12px 32px rgba(17, 24, 39, 0.06);
        margin-bottom: 20px;
      }

      .card h2 {
        margin-top: 0;
        font-size: 20px;
        color: var(--text);
        border-bottom: 1px solid var(--border);
        padding-bottom: 12px;
        margin-bottom: 20px;
      }

      .filter-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 20px;
        align-items: center;
      }

      .filter-bar input[type="search"],
      .filter-bar select {
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #ffffff;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #ffffff;
        color: var(--text);
        font-size: 14px;
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }
      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.16);
      }
      .form-group select {
        appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, var(--primary) 50%),
          linear-gradient(135deg, var(--primary) 50%, transparent 50%);
        background-position: calc(100% - 18px) center, calc(100% - 12px) center;
        background-size: 6px 6px, 6px 6px;
        background-repeat: no-repeat;
        padding-right: 36px;
        cursor: pointer;
      }

      .btn-primary {
        padding: 10px 16px;
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, var(--primary), var(--primary-2));
        color: #f9fafb;
        font-weight: 700;
        cursor: pointer;
        letter-spacing: 0.2px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .btn-primary:hover:enabled {
        transform: translateY(-1px);
        box-shadow: 0 10px 30px rgba(168, 85, 247, 0.18);
      }

      .customer-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .customer-table th,
      .customer-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }

      .customer-table th {
        background: var(--panel-2);
        font-weight: 600;
        color: var(--muted);
      }

      .customer-table tbody tr:hover {
        background: rgba(168, 85, 247, 0.05);
      }

      .btn-danger-outline {
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 8px;
        border: 1px solid var(--danger);
        background: transparent;
        color: var(--danger);
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .table-responsive {
        width: 100%;
        overflow-x: auto;
        border-radius: 12px;
      }
      .table-responsive table { min-width: 600px; }
      .btn-danger-outline:hover { background: rgba(239, 68, 68, 0.1); }

    </style>
    <style> /* Modal Styles */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; }
      .modal-overlay.active { display: flex; }
      .modal-content {
        background: var(--panel);
        padding: 28px;
        border-radius: 16px;
        width: min(90%, 520px);
        max-height: 88vh;
        overflow-y: auto;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
      .modal-header h2 { margin: 0; font-size: 18px; }
      .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
      .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }
      .btn-secondary { padding: 10px 16px; border-radius: 12px; border: 1px solid var(--border); background: #fff; color: var(--text); font-weight: 600; cursor: pointer; }
      .btn-edit-outline { padding: 4px 8px; font-size: 12px; border-radius: 8px; border: 1px solid var(--primary-2); background: transparent; color: var(--primary-2); cursor: pointer; transition: all 0.15s ease; margin-right: 6px; }
      .btn-edit-outline:hover { background: rgba(139, 92, 246, 0.1); }

      @media (max-width: 1024px) {
        main { padding: 20px; }
        .card { padding: 20px; }
      }

      @media (max-width: 768px) {
        header h1 { font-size: 16px; }
        .tabs { gap: 8px; }
        .filter-bar { flex-direction: column; align-items: stretch; }
        .filter-bar input,
        .filter-bar select { width: 100%; }
        .table-responsive table { min-width: 500px; }
        .modal-content { width: 92%; max-width: 520px; padding: 22px; max-height: 90vh; }
      }

      @media (max-width: 600px) {
        header { text-align: left; }
        .card h2 { font-size: 18px; }
        .form-group { width: 100%; }
        .tab-btn { flex: 1 1 auto; }
        .table-responsive table { min-width: 420px; }
        .modal-content { width: 96%; padding: 18px; max-height: 92vh; }
        .modal-header { flex-direction: column; align-items: flex-start; gap: 8px; }
        .modal-footer { width: 100%; flex-direction: column; }
        .modal-footer button { width: 100%; }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>
        <span style="display:inline-flex;width:12px;height:12px;border-radius:999px;background:linear-gradient(135deg,#60a5fa,#a855f7);box-shadow:0 0 0 8px rgba(96,165,250,0.15);"></span>
        CRM Dashboard
      </h1>
    </header>

    <main>
      <div class="tabs">
        <button class="tab-btn active" data-tab="customers">Customers</button>
        <button class="tab-btn" data-tab="events">Event Management</button>
        <button class="tab-btn" data-tab="packages">Packages</button>
        <button class="tab-btn" data-tab="discounts">Discount Management</button>
      </div>

      <div id="customers-content" class="tab-content active">
        <div class="card">
          <h2>Customer List</h2>
          <div class="filter-bar">
            <input type="search" id="customer-search" placeholder="Search by username or email..." style="flex-grow: 1;" />
          </div>
          <div class="table-responsive">
            <table class="customer-table">
              <thead>
                <tr>
                  <th>User ID</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Joined Date</th>
                </tr>
              </thead>
              <tbody id="customer-list-body">
                <!-- Customer data will be populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="events-content" class="tab-content">
        <div class="card">
          <h2>Add New Event</h2>
          <form id="add-event-form">
            <div class="form-group">
              <label for="event-name">Event Name</label>
              <input type="text" id="event-name" name="eventName" required />
            </div>
            <div class="form-group">
              <label for="event-date">Event Date</label>
              <input type="datetime-local" id="event-date" name="eventDate" required />
            </div>
            <div class="form-group">
              <label for="event-description">Description</label>
              <textarea id="event-description" name="eventDescription" rows="4"></textarea>
            </div>
            <button type="submit" class="btn-primary">Add Event</button>
          </form>
        </div>
      </div>

      <div id="packages-content" class="tab-content">
        <div class="card">
          <h2>Add New Package</h2>
          <form id="add-package-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="package-name">Package Name</label>
                <input type="text" id="package-name" name="name" required />
              </div>
              <div class="form-group">
                <label for="package-slug">Slug</label>
                <select id="package-slug" name="slug" required>
                  <option value="">Select slug</option>
                  <option value="basic-pc">basic-pc</option>
                  <option value="premium-pc">premium-pc</option>
                  <option value="ultimate-pc">ultimate-pc</option>
                  <option value="basic-ps">basic-ps</option>
                </select>
              </div>
              <div class="form-group">
                <label for="package-category">Category</label>
                <select id="package-category" name="category" required>
                  <option value="">Select category</option>
                  <option value="PC">PC</option>
                  <option value="PlayStation">PlayStation</option>
                  <option value="Xbox">Xbox</option>
                  <option value="Streaming">Streaming</option>
                </select>
              </div>
              <div class="form-group">
                <label for="package-type">Package Type</label>
                <select id="package-type" name="type" required>
                  <option value="">Select type</option>
                  <option value="Hourly">Hourly</option>
                  <option value="Daily">Daily</option>
                  <option value="Monthly">Monthly</option>
                </select>
              </div>
              <div class="form-group">
                <label for="package-base-price">Base Price</label>
                <input type="number" id="package-base-price" name="basePrice" min="0" step="0.01" required />
              </div>
              <div class="form-group">
                <label for="package-period">Billing Period</label>
                <input type="text" id="package-period" name="period" placeholder="/month" />
              </div>
              <div class="form-group">
                <label for="package-discount-label">Discount Label</label>
                <input type="text" id="package-discount-label" name="discountLabel" placeholder="e.g. 15% OFF" />
              </div>
              <div class="form-group">
                <label for="package-discount-percent">Discount Percent</label>
                <input type="number" id="package-discount-percent" name="discountPercent" min="0" max="100" step="1" />
              </div>
              <div class="form-group full-width">
                <label for="package-features">Features (comma separated)</label>
                <textarea id="package-features" name="features" rows="3" placeholder="Cloud saves, Premium support"></textarea>
              </div>
              <div class="form-group full-width">
                <label for="package-tags">Tags (comma separated)</label>
                <input type="text" id="package-tags" name="tags" placeholder="popular,exclusive" />
              </div>
              <div class="form-group full-width">
                <label for="package-addons">Add-ons (JSON format)</label>
                <textarea id="package-addons" name="addons" rows="4" placeholder='[{"key":"p-support","name":"Priority Support","price":5.99}]'></textarea>
              </div>
            </div>
            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="package-seasonal" name="isSeasonalOffer" value="true" style="width:auto;" />
              <label for="package-seasonal" style="margin-bottom: 0;">Seasonal Offer</label>
            </div>
            <button type="submit" class="btn-primary">Add Package</button>
          </form>

          <h2 style="margin-top: 40px;">Existing Packages</h2>
          <div class="filter-bar">
            <input type="search" id="package-search" placeholder="Search by name, slug, type..." style="flex-grow: 1;" />
            <select id="package-category-filter">
              <option value="all">All Categories</option>
              <option value="PC">PC</option>
              <option value="PlayStation">PlayStation</option>
              <option value="Xbox">Xbox</option>
              <option value="Streaming">Streaming</option>
            </select>
          </div>

          <div class="table-responsive">
            <table class="customer-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Slug</th>
                  <th>Type</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Discount</th>
                  <th>Seasonal</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="package-list-body">
                <!-- Package data populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="discounts-content" class="tab-content">
        <div class="card">
          <h2>Add New Discount</h2>
          <form id="add-discount-form">
            <div class="form-group">
              <label for="discount-code">Discount Code</label>
              <input type="text" id="discount-code" name="discountCode" required />
            </div>
            <div class="form-group">
              <label for="discount-value">Value (%)</label>
              <input type="number" id="discount-value" name="discountValue" min="1" max="100" required />
            </div>
            <div class="form-group">
              <label for="discount-expiry">Expiry Date</label>
              <input type="date" id="discount-expiry" name="discountExpiry" required />
            </div>
            <button type="submit" class="btn-primary">Add Discount</button>
          </form>

          <h2 style="margin-top: 40px;">Existing Discounts</h2>
          <div class="filter-bar">
            <input type="search" id="discount-search" placeholder="Search by code..." style="flex-grow: 1;" />
            <select id="discount-status-filter">
              <option value="all">All Statuses</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>

          <div class="table-responsive">
            <table class="customer-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Value (%)</th>
                  <th>Expiry Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="discount-list-body">
                <!-- Discount data will be populated by JS -->
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </main>

    <!-- Edit Discount Modal -->
    <div id="edit-discount-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Discount</h2>
          <button class="modal-close-btn">&times;</button>
        </div>
        <form id="edit-discount-form">
          <input type="hidden" id="edit-discount-id" name="discountId" />
          <div class="form-group">
            <label for="edit-discount-code">Discount Code</label>
            <input type="text" id="edit-discount-code" name="discountCode" required />
          </div>
          <div class="form-group">
            <label for="edit-discount-percent">Value (%)</label>
            <input type="number" id="edit-discount-percent" name="discountPercent" min="1" max="100" required />
          </div>
          <div class="form-group">
            <label for="edit-discount-expiry">Expiry Date</label>
            <input type="date" id="edit-discount-expiry" name="discountExpiry" required />
          </div>
          <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="edit-discount-is-active" name="isActive" value="true" style="width: auto;" />
            <label for="edit-discount-is-active" style="margin-bottom: 0;">
              Is Active
            </label>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-secondary modal-close-btn">Cancel</button>
            <button type="submit" class="btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Package Modal -->
    <div id="edit-package-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Package</h2>
          <button class="modal-close-btn package-close-btn">&times;</button>
        </div>
        <form id="edit-package-form">
          <input type="hidden" id="edit-package-id" name="packageId" />
          <div class="form-grid">
            <div class="form-group">
              <label for="edit-package-name">Package Name</label>
              <input type="text" id="edit-package-name" name="name" required />
            </div>
            <div class="form-group">
              <label for="edit-package-slug">Slug</label>
              <select id="edit-package-slug" name="slug" required>
                <option value="">Select slug</option>
                <option value="basic-pc">basic-pc</option>
                <option value="premium-pc">premium-pc</option>
                <option value="ultimate-pc">ultimate-pc</option>
                <option value="basic-ps">basic-ps</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-package-category">Category</label>
              <select id="edit-package-category" name="category" required>
                <option value="PC">PC</option>
                <option value="PlayStation">PlayStation</option>
                <option value="Xbox">Xbox</option>
                <option value="Streaming">Streaming</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-package-type">Package Type</label>
              <select id="edit-package-type" name="type" required>
                <option value="">Select type</option>
                <option value="Hourly">Hourly</option>
                <option value="Daily">Daily</option>
                <option value="Monthly">Monthly</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-package-base-price">Base Price</label>
              <input type="number" id="edit-package-base-price" name="basePrice" min="0" step="0.01" required />
            </div>
            <div class="form-group">
              <label for="edit-package-period">Billing Period</label>
              <input type="text" id="edit-package-period" name="period" />
            </div>
            <div class="form-group">
              <label for="edit-package-discount-label">Discount Label</label>
              <input type="text" id="edit-package-discount-label" name="discountLabel" />
            </div>
            <div class="form-group">
              <label for="edit-package-discount-percent">Discount Percent</label>
              <input type="number" id="edit-package-discount-percent" name="discountPercent" min="0" max="100" step="1" />
            </div>
            <div class="form-group full-width">
              <label for="edit-package-features">Features (comma separated)</label>
              <textarea id="edit-package-features" name="features" rows="3"></textarea>
            </div>
            <div class="form-group full-width">
              <label for="edit-package-tags">Tags (comma separated)</label>
              <input type="text" id="edit-package-tags" name="tags" />
            </div>
            <div class="form-group full-width">
              <label for="edit-package-addons">Add-ons (JSON format)</label>
              <textarea id="edit-package-addons" name="addons" rows="4"></textarea>
            </div>
          </div>
          <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="edit-package-seasonal" name="isSeasonalOffer" value="true" style="width:auto;" />
            <label for="edit-package-seasonal" style="margin-bottom: 0;">Seasonal Offer</label>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-secondary package-close-btn">Cancel</button>
            <button type="submit" class="btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>


    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const tabs = document.querySelectorAll(".tab-btn");
        const tabContents = document.querySelectorAll(".tab-content");

        // Tab switching logic
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            const target = tab.getAttribute("data-tab");

            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");

            tabContents.forEach((content) => {
              content.classList.remove("active");
              if (content.id === `${target}-content`) {
                content.classList.add("active");
              }
            });

            // Tải lại dữ liệu khi chuyển về tab tương ứng
            if (target === "customers") {
              loadCustomers();
            } else if (target === "discounts") {
              loadDiscounts();
            } else if (target === "packages") {
              loadPackages();
            }
            
          });
        });

        // --- Customer Management ---
        const customerListBody = document.getElementById("customer-list-body");

        // Placeholder function to fetch and render customers
        async function loadCustomers() {
          const searchTerm = document.getElementById('customer-search').value;
          const url = new URL('/api/crm/customers', window.location.origin);
          if (searchTerm) url.searchParams.set('search', searchTerm);

          customerListBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--muted);">Loading customers...</td></tr>';
          try {
            // Gọi API mà không cần header xác thực
            const response = await fetch(url);

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const customers = await response.json();
            renderCustomers(customers);

          } catch (error) {
            console.error("Failed to load customers:", error);
            customerListBody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--danger);">Failed to load customers. ${error.message}</td></tr>`;
          }
        }

        // Thêm event listener cho ô tìm kiếm khách hàng
        let customerSearchTimeout;
        document.getElementById('customer-search').addEventListener('input', () => { clearTimeout(customerSearchTimeout); customerSearchTimeout = setTimeout(loadCustomers, 300); });

        function renderCustomers(customers) {
          customerListBody.innerHTML = ""; // Clear existing list
          if (customers.length === 0) {
            customerListBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--muted);">No customers found.</td></tr>';
            return;
          }

          customers.forEach((customer) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${customer._id}</td>
              <td>${customer.username}</td>
              <td>${customer.email}</td>
              <td>${new Date(customer.createdAt).toLocaleDateString()}</td>
            `;
            customerListBody.appendChild(row);
          });
        }

        // --- Package Management ---
        const addPackageForm = document.getElementById("add-package-form");
        const packageListBody = document.getElementById("package-list-body");
        const packageSearchInput = document.getElementById("package-search");
        const packageCategoryFilter = document.getElementById("package-category-filter");
        let packageSearchTimeout;
        let cachedPackages = [];

        const buildPackagePayload = (formData) => ({
          name: formData.get("name")?.trim() || "",
          slug: formData.get("slug")?.trim() || "",
          category: formData.get("category") || "",
          type: formData.get("type")?.trim() || "",
          basePrice: formData.get("basePrice") || "",
          period: formData.get("period")?.trim() || "",
          discountLabel: formData.get("discountLabel")?.trim() || "",
          discountPercent: formData.get("discountPercent") || "",
          features: formData.get("features") || "",
          tags: formData.get("tags") || "",
          isSeasonalOffer: !!formData.get("isSeasonalOffer"),
          addons: (() => {
            try {
              const addonsJson = formData.get("addons")?.trim();
              return addonsJson ? JSON.parse(addonsJson) : [];
            } catch (e) {
              return []; // Trả về mảng rỗng nếu JSON không hợp lệ
            }
          })(),
        });

        if (addPackageForm) {
          addPackageForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const payload = buildPackagePayload(formData);

            fetch("/api/crm/packages", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            })
              .then((res) => {
                if (!res.ok) {
                  return res.json().then((err) => {
                    throw new Error(err.message || "Failed to add package");
                  });
                }
                return res.json();
              })
              .then(() => {
                alert("Package created successfully.");
                addPackageForm.reset();
                loadPackages();
              })
              .catch((error) => {
                console.error("Error creating package:", error);
                alert(`Error: ${error.message}`);
              });
          });
        }

        async function loadPackages() {
          if (!packageListBody) return;
          const searchTerm = packageSearchInput?.value.trim();
          const category = packageCategoryFilter?.value;
          const url = new URL("/api/packages", window.location.origin); // SỬA Ở ĐÂY
          if (searchTerm) url.searchParams.set("search", searchTerm);
          if (category && category !== "all") url.searchParams.set("category", category);

          packageListBody.innerHTML =
            '<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--muted);">Loading packages...</td></tr>';
          try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const packages = await response.json();
            cachedPackages = packages;
            renderPackages(packages);
          } catch (error) {
            console.error("Failed to load packages:", error);
            packageListBody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--danger);">Failed to load packages. ${error.message}</td></tr>`;
          }
        }

        const formatPrice = (price) => {
          const number = Number(price);
          if (Number.isNaN(number)) return price || "-";
          return `$${number.toFixed(2)}`;
        };

        function renderPackages(packages) {
          packageListBody.innerHTML = "";
          if (!packages.length) {
            packageListBody.innerHTML =
              '<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--muted);">No packages found.</td></tr>';
            return;
          }

          packages.forEach((pkg) => {
            const row = document.createElement("tr");
            const discount = pkg.discountLabel
              ? pkg.discountLabel
              : pkg.discountPercent
              ? `${pkg.discountPercent}% OFF`
              : "-";

            row.innerHTML = `
              <td>
                <strong>${pkg.name}</strong><br />
                <span style="color:var(--muted);font-size:12px;">${pkg.period || ""}</span>
              </td>
              <td>${pkg.slug}</td>
              <td>${pkg.type || "-"}</td>
              <td>${pkg.category}</td>
              <td>${formatPrice(pkg.basePrice)}</td>
              <td>${discount}</td>
              <td>${pkg.isSeasonalOffer ? "Yes" : "No"}</td>
              <td>
                <button class="btn-edit-outline" data-id="${pkg._id}">Edit</button>
                <button class="btn-danger-outline" data-id="${pkg._id}">Delete</button>
              </td>
            `;
            packageListBody.appendChild(row);
          });
        }

        if (packageSearchInput) {
          packageSearchInput.addEventListener("input", () => {
            clearTimeout(packageSearchTimeout);
            packageSearchTimeout = setTimeout(loadPackages, 300);
          });
        }
        packageCategoryFilter?.addEventListener("change", loadPackages);

        const packageModal = document.getElementById("edit-package-modal");
        const editPackageForm = document.getElementById("edit-package-form");
        const packageModalCloseButtons = packageModal?.querySelectorAll(".package-close-btn") || [];

        const listToString = (value) => {
          if (!value) return "";
          return Array.isArray(value) ? value.join(", ") : value;
        };

        function openPackageModal(pkg) {
          if (!packageModal) return;
          document.getElementById("edit-package-id").value = pkg._id;
          document.getElementById("edit-package-name").value = pkg.name || "";
          document.getElementById("edit-package-slug").value = pkg.slug || "";
          document.getElementById("edit-package-category").value = pkg.category || "PC";
          document.getElementById("edit-package-type").value = pkg.type || "";
          document.getElementById("edit-package-base-price").value = pkg.basePrice ?? "";
          document.getElementById("edit-package-period").value = pkg.period || "";
          document.getElementById("edit-package-discount-label").value = pkg.discountLabel || "";
          document.getElementById("edit-package-discount-percent").value =
            pkg.discountPercent ?? "";
          document.getElementById("edit-package-features").value = listToString(pkg.features);
          document.getElementById("edit-package-tags").value = listToString(pkg.tags);
          document.getElementById("edit-package-addons").value = pkg.addons
            ? JSON.stringify(pkg.addons, null, 2)
            : "";
          document.getElementById("edit-package-seasonal").checked = !!pkg.isSeasonalOffer;
          packageModal.classList.add("active");
        }

        function closePackageModal() {
          packageModal?.classList.remove("active");
        }

        packageModalCloseButtons.forEach((btn) => btn.addEventListener("click", closePackageModal));

        packageListBody?.addEventListener("click", (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          if (target.classList.contains("btn-danger-outline")) {
            const packageId = target.dataset.id;
            const pkg = cachedPackages.find((p) => p._id === packageId);
            const name = pkg?.name || "this package";
            if (confirm(`Delete "${name}"? This action cannot be undone.`)) {
              fetch(`/api/crm/packages/${packageId}`, { method: "DELETE" })
                .then((res) => {
                  if (!res.ok) {
                    return res.json().then((err) => {
                      throw new Error(err.message || "Failed to delete package");
                    });
                  }
                })
                .then(() => {
                  loadPackages();
                  alert("Package deleted.");
                })
                .catch((error) => {
                  console.error("Delete package error:", error);
                  alert(`Error: ${error.message}`);
                });
            }
          } else if (target.classList.contains("btn-edit-outline")) {
            const packageId = target.dataset.id;
            const pkg = cachedPackages.find((p) => p._id === packageId);
            if (pkg) {
              openPackageModal(pkg);
            }
          }
        });

        editPackageForm?.addEventListener("submit", (event) => {
          event.preventDefault();
          const formData = new FormData(editPackageForm);
          const payload = buildPackagePayload(formData);
          const packageId = formData.get("packageId");

          fetch(`/api/crm/packages/${packageId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => {
              if (!res.ok) {
                return res.json().then((err) => {
                  throw new Error(err.message || "Failed to update package");
                });
              }
              return res.json();
            })
            .then(() => {
              closePackageModal();
              loadPackages();
            })
            .catch((error) => {
              console.error("Update package error:", error);
              alert(`Error: ${error.message}`);
            });
        });

        // --- Đồng bộ Package Type và Billing Period ---
        function syncPeriodWithType(typeSelectId, periodInputId) {
          const typeSelect = document.getElementById(typeSelectId);
          const periodInput = document.getElementById(periodInputId);

          if (!typeSelect || !periodInput) return;

          // Hàm để cập nhật giá trị period
          const updatePeriod = () => {
            const selectedType = typeSelect.value;
            let periodValue = '';
            switch (selectedType) {
              case 'Hourly':
                periodValue = '/hour';
                break;
              case 'Daily':
                periodValue = '/day';
                break;
              case 'Monthly':
                periodValue = '/month';
                break;
              default:
                periodValue = '/month'; // Giá trị mặc định
            }
            periodInput.value = periodValue;
          };

          // Lắng nghe sự kiện thay đổi và gọi hàm cập nhật
          typeSelect.addEventListener('change', updatePeriod);
        }

        // --- Event Management ---
        const addEventForm = document.getElementById("add-event-form");
        addEventForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const formData = new FormData(addEventForm);
          const eventData = Object.fromEntries(formData.entries());
          console.log("Submitting new event:", eventData);
          // In a real app, you would send this to the backend:
          // fetch('/api/events', { method: 'POST', body: JSON.stringify(eventData), ... });
          alert(`Event "${eventData.eventName}" submitted! (Check console for data)`);
          addEventForm.reset();
        });

        // --- Discount Management ---
        const addDiscountForm = document.getElementById("add-discount-form");
        addDiscountForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const formData = new FormData(addDiscountForm);
          const discountData = Object.fromEntries(formData.entries());
          
          fetch('/api/crm/discounts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(discountData)
          })
          .then(res => {
            if (!res.ok) {
              return res.json().then(err => { throw new Error(err.message || 'Failed to add discount') });
            }
            return res.json();
          })
          .then(newDiscount => {
            alert(`Discount "${newDiscount.code}" added successfully!`);
            addDiscountForm.reset();
            loadDiscounts(); // Tải lại danh sách
          })
          .catch(error => {
            console.error("Error adding discount:", error);
            alert(`Error: ${error.message}`);
          });
        });

        const discountListBody = document.getElementById("discount-list-body");

        async function loadDiscounts() {
          const searchTerm = document.getElementById('discount-search').value;
          const statusFilter = document.getElementById('discount-status-filter').value;
          const url = new URL('/api/crm/discounts', window.location.origin);
          if (searchTerm) url.searchParams.set('search', searchTerm);
          if (statusFilter !== 'all') url.searchParams.set('status', statusFilter);

          discountListBody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted);">Loading discounts...</td></tr>';
          try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const discounts = await response.json();
            renderDiscounts(discounts);
          } catch (error) {
            console.error("Failed to load discounts:", error);
            discountListBody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--danger);">Failed to load discounts. ${error.message}</td></tr>`;
          }
        }

        // Thêm event listener cho tìm kiếm và lọc discount
        let discountSearchTimeout;
        document.getElementById('discount-search').addEventListener('input', () => { clearTimeout(discountSearchTimeout); discountSearchTimeout = setTimeout(loadDiscounts, 300); });
        document.getElementById('discount-status-filter').addEventListener('change', loadDiscounts);


        function renderDiscounts(discounts) {
          discountListBody.innerHTML = "";
          if (discounts.length === 0) {
            discountListBody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted);">No discounts found.</td></tr>';
            return;
          }

          discounts.forEach(discount => {
            const row = document.createElement("tr");
            // Tính toán trạng thái: Mã chỉ "Active" khi isActive=true VÀ chưa hết hạn.
            const status = discount.isActive ? 'Active' : 'Inactive';
            const statusColor = status === 'Active' ? 'var(--success)' : 'var(--muted)';

            row.innerHTML = `
              <td><strong>${discount.code}</strong></td>
              <td>${discount.discountPercent}%</td>
              <td>${new Date(discount.expiryDate).toLocaleDateString()}</td>
              <td><span style="color: ${statusColor}; font-weight: 600;">${status}</span></td>
              <td>
                <button class="btn-edit-outline" data-id="${discount._id}">Edit</button>
                <button class="btn-danger-outline" data-id="${discount._id}">Delete</button>
              </td>
            `;
            discountListBody.appendChild(row);
          });
        }

        // --- Discount Modal Logic ---
        const discountModal = document.getElementById('edit-discount-modal');
        const editDiscountForm = document.getElementById('edit-discount-form');
        const discountModalCloseBtns = discountModal.querySelectorAll('.modal-close-btn');

        function openEditModal(discount) {
          document.getElementById('edit-discount-id').value = discount._id;
          document.getElementById('edit-discount-code').value = discount.code;
          document.getElementById('edit-discount-percent').value = discount.discountPercent;
          // Format date for input type="date" (YYYY-MM-DD)
          document.getElementById('edit-discount-is-active').checked = discount.isActive;
          document.getElementById('edit-discount-expiry').value = new Date(discount.expiryDate).toISOString().split('T')[0];
          discountModal.classList.add('active');
        }

        function closeEditModal() { discountModal.classList.remove('active'); }
        discountModalCloseBtns.forEach(btn => btn.addEventListener('click', closeEditModal));

        // Xử lý sự kiện click trên bảng discount (Edit và Delete)
        discountListBody.addEventListener('click', (e) => {
          if (e.target.matches('.btn-danger-outline')) { // --- Delete Logic ---
            const discountId = e.target.dataset.id;
            const row = e.target.closest('tr');
            const code = row.querySelector('td:first-child').textContent;

            if (confirm(`Are you sure you want to delete the discount code "${code}"?`)) {
              fetch(`/api/crm/discounts/${discountId}`, { method: 'DELETE' })
                .then(res => {
                  if (!res.ok) throw new Error('Failed to delete');
                  row.remove(); // Xóa hàng khỏi bảng
                  alert('Discount deleted successfully.');
                })
                .catch(err => {
                  console.error('Delete error:', err);
                  alert('An error occurred while deleting the discount.');
                });
            }
          } else if (e.target.matches('.btn-edit-outline')) { // --- Edit Logic ---
            const discountId = e.target.dataset.id;
            // Lấy thông tin chi tiết của discount từ API hoặc cache (ở đây ta gọi API cho đơn giản)
            fetch(`/api/crm/discounts`)
              .then(res => res.json())
              .then(discounts => {
                const discountToEdit = discounts.find(d => d._id === discountId);
                if (discountToEdit) {
                  openEditModal(discountToEdit);
                } else {
                  alert('Could not find discount details.');
                }
              });
          }
        });

        // Xử lý submit form chỉnh sửa
        editDiscountForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const formData = new FormData(editDiscountForm);
          const discountData = Object.fromEntries(formData.entries());
          const discountId = discountData.discountId;

          // Xử lý checkbox (nếu không check, nó sẽ không có trong formData)
          if (!discountData.isActive) {
            discountData.isActive = false;
          }

          fetch(`/api/crm/discounts/${discountId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(discountData)
          })
          .then(res => {
            if (!res.ok) return res.json().then(err => { throw new Error(err.message || 'Failed to update') });
            return res.json();
          })
          .then(() => {
            closeEditModal();
            loadDiscounts(); // Tải lại danh sách để thấy thay đổi
          })
          .catch(err => alert(`Error: ${err.message}`));
        });

        // Initial load
        loadCustomers();

        // Kích hoạt đồng bộ cho cả hai form
        syncPeriodWithType('package-type', 'package-period');
        syncPeriodWithType('edit-package-type', 'edit-package-period');
        // Không cần loadDiscounts() ban đầu vì tab đó không active
      });
    </script>
  </body>
</html>
